"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const node_xlsx_1 = __importDefault(require("node-xlsx"));
const fs_extra_1 = __importDefault(require("fs-extra"));
class DbI18nChecker {
    static check_i18n_config() {
        this._all_language_ids = [];
        //首先读取_config/resources/语言配置_i18n_language_config_db.xlsx
        const filePath = path_1.default.join(Editor.Project.path, '_config/resources/语言配置_i18n_language_config_db.xlsx');
        //读表格
        const sheets = node_xlsx_1.default.parse(fs_extra_1.default.readFileSync(filePath));
        if (!sheets) {
            return;
        }
        //获取第一个sheet
        const sheet = sheets[0];
        if (!sheet) {
            return;
        }
        const data = sheet.data;
        if (!data) {
            return;
        }
        //从第9行开始读取数据
        //获取所有的语言id
        for (let i = 8; i < data.length; i++) {
            const row = data[i];
            if (!row) {
                continue;
            }
            const language_id = row[2];
            if (!language_id) {
                continue;
            }
            this._all_language_ids.push(language_id);
            this._all_language_names.push(row[1]);
        }
        //console.warn('check_i18n_config -> ', this._all_language_ids);
        //对所有bundle中的多语言配置表进行检测
        const _configUrl = path_1.default.join(Editor.Project.path, '_config');
        //获取_configUrl下的所有 文件夹 的名字
        const dirs = fs_extra_1.default.readdirSync(_configUrl);
        for (let i = 0; i < dirs.length; i++) {
            const dir = dirs[i];
            const dirPath = path_1.default.join(_configUrl, dir);
            //判断是否是文件夹
            const stat = fs_extra_1.default.statSync(dirPath);
            if (!stat.isDirectory()) {
                continue;
            }
            // if(dir != 'resources'){
            //     continue;
            // }
            //获取多语言配置表
            const dbPath = path_1.default.join(dirPath, '多语言_i18n_' + dir + '_db.xlsx');
            if (!fs_extra_1.default.existsSync(dbPath)) {
                console.error('多语言配置表不存在 -> ', dbPath);
                continue;
            }
            this.check_i18n_db(dbPath);
        }
    }
    static check_i18n_db(dbPath) {
        const sheets = node_xlsx_1.default.parse(fs_extra_1.default.readFileSync(dbPath));
        if (!sheets) {
            return;
        }
        //获取第一个sheet
        const sheet = sheets[0];
        if (!sheet) {
            return;
        }
        const datas = sheet.data;
        if (!datas) {
            return;
        }
        //找到第一列数据为FLD_NAME的行
        let keyIndex = -1;
        let fldName = null;
        for (let i = 0; i < datas.length; i++) {
            const row = datas[i];
            if (!row) {
                continue;
            }
            if (row[0] == 'FLD_NAME') {
                keyIndex = i;
                fldName = row;
                break;
            }
        }
        if (keyIndex == -1) {
            console.error('没有找到FLD_NAME字段');
            return;
        }
        let newerLanguageIds = [];
        let newerLanguageNames = [];
        let newerFiledTypes = [];
        for (let i = 0; i < this._all_language_ids.length; i++) {
            const language_id = this._all_language_ids[i];
            if (!fldName.includes(language_id)) {
                newerLanguageIds.push(language_id);
                newerLanguageNames.push(this._all_language_names[i]);
                newerFiledTypes.push('S');
            }
        }
        if (newerLanguageIds.length == 0) {
            //没有需要更新的语言字段
            return;
        }
        let fildType = datas[keyIndex - 1];
        let fildDesc = datas[keyIndex + 1];
        //在最后一列插入新的语言id
        fldName.push(...newerLanguageIds);
        fildDesc.push(...newerLanguageNames);
        fildType.push(...newerFiledTypes);
        //检测新的语言是否有en字段
        let enIndex = -1;
        let en_us_index = -1;
        for (let i = 0; i < fldName.length; i++) {
            if (!fldName[i]) {
                continue;
            }
            if (fldName[i] == 'en_us') {
                en_us_index = i;
                continue;
            }
            if (fldName[i].includes('en') && fldName[i] != 'en_us') {
                enIndex = i;
                break;
            }
        }
        console.warn('check_i18n_db -> ', newerLanguageIds, enIndex, en_us_index);
        if (enIndex != -1 && en_us_index != -1) {
            for (let i = 0; i < datas.length; i++) {
                const rowData = datas[i];
                if (rowData[0] == "DATA") {
                    rowData[enIndex] = rowData[en_us_index];
                }
            }
        }
        //写入新的数据
        //写入文件
        const sheetOptions = { '!cols': [{ wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }] };
        const buffer = node_xlsx_1.default.build([{ name: sheet.name, data: datas, options: sheetOptions }]);
        fs_extra_1.default.writeFileSync(dbPath, buffer, { encoding: "binary" });
        console.warn(dbPath + ' : writeNewLanguage -> ', newerLanguageIds);
    }
}
exports.default = DbI18nChecker;
/**
 * 当前所有的语言id
 */
DbI18nChecker._all_language_ids = [];
DbI18nChecker._all_language_names = [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGItaTE4bi1jaGVja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2RiX2kxOG5fY2hlY2svZGItaTE4bi1jaGVja2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDBEQUE2QjtBQUM3Qix3REFBMEI7QUFDMUIsTUFBcUIsYUFBYTtJQU92QixNQUFNLENBQUMsaUJBQWlCO1FBQzNCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIseURBQXlEO1FBQ3pELE1BQU0sUUFBUSxHQUFJLGNBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUscURBQXFELENBQUMsQ0FBQztRQUN4RyxLQUFLO1FBQ0wsTUFBTSxNQUFNLEdBQU0sbUJBQUksQ0FBQyxLQUFLLENBQUMsa0JBQUUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUN4RCxJQUFHLENBQUMsTUFBTSxFQUFDO1lBQ1AsT0FBTztTQUNWO1FBQ0QsWUFBWTtRQUNaLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixJQUFHLENBQUMsS0FBSyxFQUFDO1lBQ04sT0FBTztTQUNWO1FBRUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFHLENBQUMsSUFBSSxFQUFDO1lBQ0wsT0FBTztTQUNWO1FBQ0QsWUFBWTtRQUNaLFdBQVc7UUFDWCxLQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBQztZQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBRyxDQUFDLEdBQUcsRUFBQztnQkFDSixTQUFTO2FBQ1o7WUFDRCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFD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UUFDOUUsTUFBTSxNQUFNLEdBQVUsbUJBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFDLElBQUksRUFBRyxLQUFLLENBQUMsSUFBSSxFQUFDLElBQUksRUFBRyxLQUFLLEVBQUMsT0FBTyxFQUFHLFlBQVksRUFBQyxDQUFDLENBQUMsQ0FBQztRQUM1RixrQkFBRSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUMsTUFBTSxFQUFDLEVBQUMsUUFBUSxFQUFHLFFBQVEsRUFBQyxDQUFDLENBQUM7UUFDdEQsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcseUJBQXlCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUN2RSxDQUFDOztBQXpKTCxnQ0EySkM7QUExSkc7O0dBRUc7QUFDWSwrQkFBaUIsR0FBYyxFQUFFLENBQUM7QUFDbEMsaUNBQW1CLEdBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcclxuaW1wb3J0IHhsc3ggZnJvbSBcIm5vZGUteGxzeFwiO1xyXG5pbXBvcnQgZnMgZnJvbSBcImZzLWV4dHJhXCI7XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERiSTE4bkNoZWNrZXIge1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPliY3miYDmnInnmoTor63oqIBpZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfYWxsX2xhbmd1YWdlX2lkcyA6IHN0cmluZ1tdID0gW107XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfYWxsX2xhbmd1YWdlX25hbWVzIDogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGNoZWNrX2kxOG5fY29uZmlnKCkge1xyXG4gICAgICAgIHRoaXMuX2FsbF9sYW5ndWFnZV9pZHMgPSBbXTtcclxuICAgICAgICAvL+mmluWFiOivu+WPll9jb25maWcvcmVzb3VyY2VzL+ivreiogOmFjee9rl9pMThuX2xhbmd1YWdlX2NvbmZpZ19kYi54bHN4XHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggID0gcGF0aC5qb2luKEVkaXRvci5Qcm9qZWN0LnBhdGgsICdfY29uZmlnL3Jlc291cmNlcy/or63oqIDphY3nva5faTE4bl9sYW5ndWFnZV9jb25maWdfZGIueGxzeCcpO1xyXG4gICAgICAgIC8v6K+76KGo5qC8XHJcbiAgICAgICAgY29uc3Qgc2hlZXRzICAgID0geGxzeC5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgpKTtcclxuICAgICAgICBpZighc2hlZXRzKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL+iOt+WPluesrOS4gOS4qnNoZWV0XHJcbiAgICAgICAgY29uc3Qgc2hlZXQgPSBzaGVldHNbMF07XHJcbiAgICAgICAgaWYoIXNoZWV0KXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBkYXRhID0gc2hlZXQuZGF0YTtcclxuICAgICAgICBpZighZGF0YSl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy/ku47nrKw56KGM5byA5aeL6K+75Y+W5pWw5o2uXHJcbiAgICAgICAgLy/ojrflj5bmiYDmnInnmoTor63oqIBpZFxyXG4gICAgICAgIGZvcihsZXQgaSA9IDg7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gZGF0YVtpXTtcclxuICAgICAgICAgICAgaWYoIXJvdyl7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBsYW5ndWFnZV9pZCA9IHJvd1syXTtcclxuICAgICAgICAgICAgaWYoIWxhbmd1YWdlX2lkKXtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX2FsbF9sYW5ndWFnZV9pZHMucHVzaChsYW5ndWFnZV9pZCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2FsbF9sYW5ndWFnZV9uYW1lcy5wdXNoKHJvd1sxXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2NvbnNvbGUud2FybignY2hlY2tfaTE4bl9jb25maWcgLT4gJywgdGhpcy5fYWxsX2xhbmd1YWdlX2lkcyk7XHJcbiAgICAgICAgLy/lr7nmiYDmnIlidW5kbGXkuK3nmoTlpJror63oqIDphY3nva7ooajov5vooYzmo4DmtYtcclxuICAgICAgICBjb25zdCBfY29uZmlnVXJsID0gcGF0aC5qb2luKEVkaXRvci5Qcm9qZWN0LnBhdGgsICdfY29uZmlnJyk7XHJcbiAgICAgICAgLy/ojrflj5ZfY29uZmlnVXJs5LiL55qE5omA5pyJIOaWh+S7tuWkuSDnmoTlkI3lrZdcclxuICAgICAgICBjb25zdCBkaXJzID0gZnMucmVhZGRpclN5bmMoX2NvbmZpZ1VybCk7XHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGRpcnMubGVuZ3RoOyBpKyspe1xyXG4gICAgICAgICAgICBjb25zdCBkaXIgICAgICAgPSBkaXJzW2ldO1xyXG4gICAgICAgICAgICBjb25zdCBkaXJQYXRoICAgPSBwYXRoLmpvaW4oX2NvbmZpZ1VybCwgZGlyKTtcclxuICAgICAgICAgICAgLy/liKTmlq3mmK/lkKbmmK/mlofku7blpLlcclxuICAgICAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGRpclBhdGgpO1xyXG4gICAgICAgICAgICBpZighc3RhdC5pc0RpcmVjdG9yeSgpKXtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIGlmKGRpciAhPSAncmVzb3VyY2VzJyl7XHJcbiAgICAgICAgICAgIC8vICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAvL+iOt+WPluWkmuivreiogOmFjee9ruihqFxyXG4gICAgICAgICAgICBjb25zdCBkYlBhdGggPSBwYXRoLmpvaW4oZGlyUGF0aCwgJ+WkmuivreiogF9pMThuXycgKyBkaXIgKyAnX2RiLnhsc3gnKTtcclxuICAgICAgICAgICAgaWYoIWZzLmV4aXN0c1N5bmMoZGJQYXRoKSl7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCflpJror63oqIDphY3nva7ooajkuI3lrZjlnKggLT4gJywgZGJQYXRoKTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuY2hlY2tfaTE4bl9kYihkYlBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBjaGVja19pMThuX2RiKGRiUGF0aCA6IHN0cmluZyl7XHJcbiAgICAgICAgY29uc3Qgc2hlZXRzICAgID0geGxzeC5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZGJQYXRoKSk7XHJcbiAgICAgICAgaWYoIXNoZWV0cyl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy/ojrflj5bnrKzkuIDkuKpzaGVldFxyXG4gICAgICAgIGNvbnN0IHNoZWV0ID0gc2hlZXRzWzBdO1xyXG4gICAgICAgIGlmKCFzaGVldCl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGF0YXMgPSBzaGVldC5kYXRhO1xyXG4gICAgICAgIGlmKCFkYXRhcyl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy/mib7liLDnrKzkuIDliJfmlbDmja7kuLpGTERfTkFNReeahOihjFxyXG4gICAgICAgIGxldCBrZXlJbmRleCA9IC0xO1xyXG4gICAgICAgIGxldCBmbGROYW1lIDogYW55W10gPSBudWxsO1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBkYXRhcy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IGRhdGFzW2ldO1xyXG4gICAgICAgICAgICBpZighcm93KXtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHJvd1swXSA9PSAnRkxEX05BTUUnKXtcclxuICAgICAgICAgICAgICAgIGtleUluZGV4ICAgID0gaTtcclxuICAgICAgICAgICAgICAgIGZsZE5hbWUgICAgID0gcm93O1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYoa2V5SW5kZXggPT0gLTEpe1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCfmsqHmnInmib7liLBGTERfTkFNReWtl+autScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBuZXdlckxhbmd1YWdlSWRzIDogc3RyaW5nW10gICAgID0gW107XHJcbiAgICAgICAgbGV0IG5ld2VyTGFuZ3VhZ2VOYW1lcyA6IHN0cmluZ1tdICAgPSBbXTtcclxuICAgICAgICBsZXQgbmV3ZXJGaWxlZFR5cGVzIDogc3RyaW5nW10gICAgICA9IFtdO1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7aTx0aGlzLl9hbGxfbGFuZ3VhZ2VfaWRzLmxlbmd0aDtpKyspe1xyXG4gICAgICAgICAgICBjb25zdCBsYW5ndWFnZV9pZCA9IHRoaXMuX2FsbF9sYW5ndWFnZV9pZHNbaV07XHJcbiAgICAgICAgICAgIGlmKCFmbGROYW1lLmluY2x1ZGVzKGxhbmd1YWdlX2lkKSl7XHJcbiAgICAgICAgICAgICAgICBuZXdlckxhbmd1YWdlSWRzLnB1c2gobGFuZ3VhZ2VfaWQpO1xyXG4gICAgICAgICAgICAgICAgbmV3ZXJMYW5ndWFnZU5hbWVzLnB1c2godGhpcy5fYWxsX2xhbmd1YWdlX25hbWVzW2ldKTtcclxuICAgICAgICAgICAgICAgIG5ld2VyRmlsZWRUeXBlcy5wdXNoKCdTJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYobmV3ZXJMYW5ndWFnZUlkcy5sZW5ndGggPT0gMCl7XHJcbiAgICAgICAgICAgIC8v5rKh5pyJ6ZyA6KaB5pu05paw55qE6K+t6KiA5a2X5q61XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGZpbGRUeXBlICAgID0gZGF0YXNba2V5SW5kZXggLSAxXTtcclxuICAgICAgICBsZXQgZmlsZERlc2MgICAgPSBkYXRhc1trZXlJbmRleCArIDFdO1xyXG4gICAgICAgIC8v5Zyo5pyA5ZCO5LiA5YiX5o+S5YWl5paw55qE6K+t6KiAaWRcclxuICAgICAgICBmbGROYW1lLnB1c2goLi4ubmV3ZXJMYW5ndWFnZUlkcyk7XHJcbiAgICAgICAgZmlsZERlc2MucHVzaCguLi5uZXdlckxhbmd1YWdlTmFtZXMpO1xyXG4gICAgICAgIGZpbGRUeXBlLnB1c2goLi4ubmV3ZXJGaWxlZFR5cGVzKTtcclxuICAgICAgICAvL+ajgOa1i+aWsOeahOivreiogOaYr+WQpuaciWVu5a2X5q61XHJcbiAgICAgICAgbGV0IGVuSW5kZXggPSAtMTtcclxuICAgICAgICBsZXQgZW5fdXNfaW5kZXggPSAtMTtcclxuICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgZmxkTmFtZS5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgIGlmKCFmbGROYW1lW2ldKXtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKGZsZE5hbWVbaV0gPT0gJ2VuX3VzJyl7XHJcbiAgICAgICAgICAgICAgICBlbl91c19pbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihmbGROYW1lW2ldLmluY2x1ZGVzKCdlbicpICYmIGZsZE5hbWVbaV0gIT0gJ2VuX3VzJyl7XHJcbiAgICAgICAgICAgICAgICBlbkluZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUud2FybignY2hlY2tfaTE4bl9kYiAtPiAnLCBuZXdlckxhbmd1YWdlSWRzLGVuSW5kZXgsZW5fdXNfaW5kZXgpO1xyXG4gICAgICAgIGlmKGVuSW5kZXggIT0gLTEgJiYgZW5fdXNfaW5kZXggIT0gLTEpe1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDtpPGRhdGFzLmxlbmd0aDtpKyspe1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgcm93RGF0YSA9IGRhdGFzW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYocm93RGF0YVswXSA9PSBcIkRBVEFcIil7XHJcbiAgICAgICAgICAgICAgICAgICAgcm93RGF0YVtlbkluZGV4XSA9IHJvd0RhdGFbZW5fdXNfaW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL+WGmeWFpeaWsOeahOaVsOaNrlxyXG4gICAgICAgIC8v5YaZ5YWl5paH5Lu2XHJcbiAgICAgICAgY29uc3Qgc2hlZXRPcHRpb25zICA9IHsnIWNvbHMnOiBbe3djaDogMjB9LCB7d2NoOiAyMH0sIHt3Y2g6IDIwfSwge3djaDogMjB9XX07XHJcbiAgICAgICAgY29uc3QgYnVmZmVyICAgICAgICA9IHhsc3guYnVpbGQoW3tuYW1lIDogc2hlZXQubmFtZSxkYXRhIDogZGF0YXMsb3B0aW9ucyA6IHNoZWV0T3B0aW9uc31dKTtcclxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGRiUGF0aCxidWZmZXIse2VuY29kaW5nIDogXCJiaW5hcnlcIn0pO1xyXG4gICAgICAgIGNvbnNvbGUud2FybihkYlBhdGggKyAnIDogd3JpdGVOZXdMYW5ndWFnZSAtPiAnLCBuZXdlckxhbmd1YWdlSWRzKTtcclxuICAgIH0gICBcclxuXHJcbn0gICAiXX0=